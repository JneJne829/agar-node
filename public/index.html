<!-- public/index.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Agar-Lite</title>
  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#111;}
    canvas{display:block;width:100%;height:100%;background:#111;}
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<canvas id="game"></canvas>
<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Áï´Èù¢Â∏∏Êï∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const GRID_SIZE=100,WORLD_SIZE=6000,BASE_SCALE=2,MIN_ZOOM=0.6,MAX_ZOOM=1.8,FADE=200;

/* Canvas */
const cv=document.getElementById('game'),ctx=cv.getContext('2d');
function resize(){cv.width=innerWidth;cv.height=innerHeight;}resize();addEventListener('resize',resize);

/* ÊªëÈº† */
let mouseX=0,mouseY=0;
addEventListener('mousemove',e=>{mouseX=e.clientX;mouseY=e.clientY;});

/* Socket */
const socket=io();
let players={},feeds=new Map(),myId=null;

/* ÂãïÁï´Êö´Â≠ò */
const smoothR=new Map(),lastInfo=new Map(),fading=new Map();

socket.on('init',d=>{
  players=d.players;
  feeds=new Map(d.feeds.map(f=>[f.id,f]));
  myId=socket.id;
});
socket.on('update',d=>{
  players=d.players;

  /* Êñ∞Â¢ûÔºèÁßªÈô§ */
  for(const f of d.feedsAdded)   feeds.set(f.id,f);
  for(const id of d.feedsRemoved)feeds.delete(id);

  /* üî∏ ‰ΩçÁΩÆÊõ¥Êñ∞ÔºöÂè™ËôïÁêÜ server Á´ØÂõûÂÇ≥ÁöÑ moved ÂàóË°® */
  if(d.feedsMoved){
    for(const f of d.feedsMoved){
      const ex=feeds.get(f.id);
      if(ex){
        ex.x=f.x;ex.y=f.y;ex.vx=f.vx;ex.vy=f.vy;
      }else{
        feeds.set(f.id,f);           // Ëê¨‰∏ÄÊú¨Âú∞Ê≤íÊúâÂ∞±Áõ¥Êé•Ë£ú
      }
    }
  }
});

/* --------- Êìç‰Ωú --------- */
addEventListener('keydown',e=>{
  const me=players[myId];
  if(!me)return;
  const wx=camX+(mouseX-cv.width/2)/zoom;
  const wy=camY+(mouseY-cv.height/2)/zoom;
  if(e.code==='Space') socket.emit('split',{tx:wx,ty:wy});
  if(e.code==='KeyW')  socket.emit('eject',{tx:wx,ty:wy});
});

/* --------- ‰∏ªËø¥Âúà --------- */
let camX=0,camY=0,zoom=BASE_SCALE,prev=performance.now();
function frame(now){
  const dt=now-prev;prev=now;
  const me=players[myId];

  /* Èè°È†≠ & Á∏ÆÊîæ */
  if(me){
    let sumA=0,cx=0,cy=0;
    for(const c of me.cells){const a=c.size*c.size;sumA+=a;cx+=c.x*a;cy+=c.y*a;}
    if(sumA){camX=cx/sumA;camY=cy/sumA;}
    const half=WORLD_SIZE/2,viewW=cv.width/(2*zoom),viewH=cv.height/(2*zoom);
    camX=Math.min(half-viewW,Math.max(-half+viewW,camX));
    camY=Math.min(half-viewH,Math.max(-half+viewH,camY));
    const targetZ=BASE_SCALE*Math.sqrt(20/Math.sqrt(sumA));
    zoom+=(Math.min(MAX_ZOOM,Math.max(MIN_ZOOM,targetZ))-zoom)*0.08;
  }

  /* ÂÇ≥ÈÄÅÁõÆÊ®ô */
  if(me){
    socket.emit('moveTo',{
      mx:camX+(mouseX-cv.width/2)/zoom,
      my:camY+(mouseY-cv.height/2)/zoom
    });
  }

  /* Áï´Â∏ÉËΩâÊèõ */
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.save();ctx.translate(cv.width/2,cv.height/2);ctx.scale(zoom,zoom);ctx.translate(-camX,-camY);

  /* ËÉåÊôØÊ†ºÁ∑ö */
  ctx.strokeStyle='#444';ctx.lineWidth=1/zoom;
  for(let x=-WORLD_SIZE/2;x<=WORLD_SIZE/2;x+=GRID_SIZE){
    ctx.beginPath();ctx.moveTo(x,-WORLD_SIZE/2);ctx.lineTo(x,WORLD_SIZE/2);ctx.stroke();
  }
  for(let y=-WORLD_SIZE/2;y<=WORLD_SIZE/2;y+=GRID_SIZE){
    ctx.beginPath();ctx.moveTo(-WORLD_SIZE/2,y);ctx.lineTo(WORLD_SIZE/2,y);ctx.stroke();
  }

  /* Feed */
  if(me){
    const pad=100,minX=camX-(cv.width/2+pad)/zoom,maxX=camX+(cv.width/2+pad)/zoom;
    const minY=camY-(cv.height/2+pad)/zoom,maxY=camY+(cv.height/2+pad)/zoom;
    for(const f of feeds.values()){
      if(f.x<minX||f.x>maxX||f.y<minY||f.y>maxY)continue;
      ctx.beginPath();ctx.arc(f.x,f.y,f.size,0,Math.PI*2);
      ctx.fillStyle=f.color||'#88cc88';ctx.fill();
    }
  }

  /* Áé©ÂÆ∂Á¥∞ËÉû */
  const all=[];
  for(const pid in players){
    const col=players[pid].color||'#fff';
    for(const c of players[pid].cells)all.push({c,col});
  }
  all.sort((a,b)=>a.c.size-b.c.size);
  const present=new Set();
  for(const {c,col} of all){
    if(!smoothR.has(c.id))smoothR.set(c.id,c.size);
    const r=smoothR.get(c.id)+(c.size-smoothR.get(c.id))*0.05;
    smoothR.set(c.id,r);lastInfo.set(c.id,{x:c.x,y:c.y,col});
    ctx.beginPath();ctx.arc(c.x,c.y,r,0,Math.PI*2);
    ctx.fillStyle=col;ctx.fill();present.add(c.id);
  }

  /* Ê∑°Âá∫ */
  for(const id of smoothR.keys()){
    if(present.has(id))continue;
    if(!fading.has(id)){
      const info=lastInfo.get(id)||{x:camX,y:camY,col:'#fff'};
      fading.set(id,{x:info.x,y:info.y,r:smoothR.get(id),col:info.col,t:FADE});
      smoothR.delete(id);lastInfo.delete(id);
    }
  }
  for(const [id,o] of fading){
    o.t-=dt;if(o.t<=0){fading.delete(id);continue;}
    const a=o.t/FADE;
    ctx.globalAlpha=a;
    ctx.beginPath();ctx.arc(o.x,o.y,o.r*a,0,Math.PI*2);
    ctx.fillStyle=o.col;ctx.fill();ctx.globalAlpha=1;
  }

  ctx.restore();requestAnimationFrame(frame);
}
requestAnimationFrame(frame);
</script>
</body>
</html>